<!DOCTYPE HTML>

<html>
    <head>
        <meta charset="UTF-8" />
        <title>Janken : Battle !</title>
        <link rel="stylesheet" href="/styles.css" />
    </head>

    <body>
        <h1>Bienvenue sur Janken <b class="welcome"><%= user.username %></b> !</h1>

        <a href="/">Retour à l'accueil</a>

        <h3>Room n°<span class="number_room"><%= user.room %></span></h3>

        <ul class="room_users">
            
        </ul>

        <ul>
            <li><button>Pierre</button></button></li>
            <li><button>Feuille</button></button></li>
            <li><button>Ciseaux</button></button></li>
        </ul>

        <div class="janken"></div>

        <br />
        <div>Votre score est de : <span class="score">0</span></div>

        <div class="battle"></div>

        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/connect_io.js"></script>


        <script>
            var domicile = '';
            var exterieur = '';
            var deja_joue = 0;
            var score = 0;

            socket.emit('roomJoined', {
                koko : 'test'
            });

            socket.on('newUser', function(user) {
                $('.janken').append('<div>nouvel arrivant : '+user.user.username+'</div>');
            });

            socket.on('janken', function(janken) {
                exterieur = janken.janken;

                if(domicile !== '') { // Lorsque l'adversaire a joué, si on a déjà joué
                    if(deja_joue === 0) {
                        $('.janken').append('<p>Vous avez joué <b>'+domicile+'</b></p>');
                    }
                    $('.janken').append('<p>Votre adversaire a joué <b>'+exterieur+'</b></p>');
                    calculScore(domicile, exterieur);
                }
            });

            $('ul li button').click(function () {
                $('.janken').empty();
                socket.emit('janken', $(this).text());
                domicile = $(this).text();

                $('.janken').append('<p>Vous avez joué <b>'+domicile+'</b></p>');
                deja_joue = 1;

                if(exterieur !== '') { // Lorsqu'on joue, si l'adversaire a déjà joué
                    $('.janken').append('<p>Votre adversaire a joué <b>'+exterieur+'</b></p>');
                    calculScore(domicile, exterieur);
                }
            });

            function calculScore(first, second) {
                if(first === 'Ciseaux') {
                    if(second === 'Pierre') {
                        battle('ciseaux_left', 'pierre_right', 0);
                    } else if(second === 'Feuille') {
                        battle('ciseaux_left', 'feuille_right', 1);
                    } else if(second === 'Ciseaux') {
                        battle('ciseaux_left', 'ciseaux_right', 2);
                    }
                } else if(first === 'Pierre') {
                    if(second === 'Feuille') {
                        battle('pierre_left', 'feuille_right', 0);
                    } else if(second === 'Ciseaux') {
                        battle('pierre_left', 'ciseaux_right', 1);
                    } else if(second === 'Pierre') {
                        battle('pierre_left', 'pierre_right', 2);
                    }
                } else if(first === 'Feuille') {
                    if(second === 'Ciseaux') {
                        battle('feuille_left', 'ciseaux_right', 0);
                    } else if(second === 'Pierre') {
                        battle('feuille_left', 'pierre_right', 1);
                    } else if(second === 'Feuille') {
                        battle('feuille_left', 'feuille_right', 2);
                    }
                }
                
            }

            function battle(left, right, result) {

                var battle =
                    '<div class="'+left+'">' +
                        '<img src="/'+left+'.png" width="300" />' +
                    '</div>' +
                    '<div class="'+right+'">' +
                        '<img src="/'+right+'.png" width="300" />' +
                    '</div>'
                ;

                $('.battle').append(battle);

                $('.'+left).animate({
                    left: "+=100",
                  }, 550, function() {
                    $('.'+left).animate({
                        left: "-=100",
                      }, 150, function() {
                    });
                });

                $('.'+right).animate({
                    right: "+=100",
                  }, 550, function() {
                    $('.'+right).animate({
                        right: "-=100",
                      }, 150, function() {
                    });
                });

                endBattle(result);
            }

            function endBattle(result) {

                setTimeout(function() {
                    $('.battle').empty();
                    if(result === 0) {
                        $('.battle').append('<h1>DEFAITE !</h1>');
                    } else if(result === 1) {
                        $('.battle').append('<h1>VICTOIRE !</h1>');
                        score++;
                    } else if(result === 2) {
                        $('.battle').append('<h1>MATCH NUL !</h1>');
                    }

                    setTimeout(function() {
                        $('.battle').empty();
                        $('.score').text(score);
                        domicile = '';
                        exterieur = '';
                        deja_joue = 0;
                    }, 1000);
                }, 1500);
            }


        </script>
        
    </body>
</html>

